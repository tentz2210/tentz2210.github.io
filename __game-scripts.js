var Constants=pc.createScript("constants");const COLS=10,ROWS=20,LINES_PER_LEVEL=10,SHAPES=[[],[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[1,0,0],[1,1,1],[0,0,0]],[[0,0,1],[1,1,1],[0,0,0]],[[1,1],[1,1]],[[0,1,1],[1,1,0],[0,0,0]],[[0,1,0],[1,1,1],[0,0,0]],[[1,1,0],[0,1,1],[0,0,0]]],KEY={ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,P:80,Q:81},ROTATION={LEFT:"left",RIGHT:"right"},POINTS={SINGLE:100,DOUBLE:300,TRIPLE:500,TETRIS:800,SOFT_DROP:1,HARD_DROP:2},LEVEL={0:800,1:720,2:630,3:550,4:470,5:380,6:300,7:220,8:130,9:100,10:80,11:80,12:80,13:70,14:70,15:70,16:50,17:50,18:50,19:30,20:30};"use strict";var Piece=pc.createScript("piece"),entP=null,nextEnt=null;class TPiece{constructor(t){this.isNext=t,this.spawn()}spawn(){this.typeId=this.randomizeTetrominoType(SHAPES.length-1),this.shape=SHAPES[this.typeId],this.color=new pc.Color(255,0,0),this.x=0,this.y=0,this.hardDropped=!1}draw(){this.isNext&&this.clearNext(),this.shape.forEach(((t,e)=>{t.forEach(((t,i)=>{this.isNext?t>0&&(nextEnt.findByPath(["R"+e,i.toString()]).element.color=this.color):t>0&&(entP.findByPath(["R"+(this.y+e),(this.x+i).toString()]).element.color=this.color)}))}))}clearNext(){nextEnt.forEach((function(t){t.element&&(t.element.color=new pc.Color(255,255,255))}))}move(t){this.hardDropped||(this.x=t.x,this.y=t.y),this.shape=t.shape}hardDrop(){this.hardDropped=!0}setStartingPosition(){this.x=4===this.typeId?4:3}randomizeTetrominoType(t){return Math.floor(Math.random()*t+1)}}[SHAPES,KEY,ROTATION,LEVEL,POINTS].forEach((t=>Object.freeze(t))),Piece.prototype.initialize=function(){entP=this.entity,nextEnt=this.entity.parent.findByName("NextBoard")},Piece.prototype.update=function(t){};var Board=pc.createScript("board"),ent=null,nextEnt=null;Board.prototype.initialize=function(){ent=this.entity,nextEnt=this.entity.parent.findByName("NextBoard"),console.log(nextEnt.element.color),console.log(this.entity.findByPath("R1/2").name),this.entity.findByPath(["R1","2"]).element.color=new pc.Color(255,0,0)},Board.prototype.update=function(t){};var Main=pc.createScript("main");Main.attributes.add("menuEntity",{type:"entity"});var refToSelf,gui=this.entity;let accountValues={score:0,level:0,lines:0};function updateAccount(e,t){let i=gui.findByName(e+"Label");console.log(e+"Label"),i&&(i.element.text=e+": "+t)}let account=new Proxy(accountValues,{set:(e,t,i)=>(e[t]=i,updateAccount(t,i),!0)}),time=null;const moves={[pc.KEY_LEFT]:e=>({...e,x:e.x-1}),[pc.KEY_RIGHT]:e=>({...e,x:e.x+1}),[pc.KEY_DOWN]:e=>({...e,y:e.y+1}),[pc.KEY_SPACE]:e=>({...e,y:e.y+1}),[pc.KEY_UP]:e=>board.rotate(e,ROTATION.RIGHT),[pc.KEY_Q]:e=>board.rotate(e,ROTATION.LEFT)};class TBoard{reset(){this.grid=this.getEmptyGrid(),this.piece=new TPiece(!1),this.piece.setStartingPosition(),this.getNewPiece()}getNewPiece(){this.next=new TPiece(!0),this.next.draw()}draw(){this.drawBoard(),this.piece.draw()}drop(){let e=moves[KEY.DOWN](this.piece);if(this.valid(e))this.piece.move(e);else{if(this.freeze(),this.clearLines(),0===this.piece.y)return!1;this.piece=this.next,this.piece.isNext=!1,this.piece.setStartingPosition(),this.getNewPiece()}return!0}clearLines(){let e=0;this.grid.forEach(((t,i)=>{t.every((e=>e>0))&&(e++,this.grid.splice(i,1),this.grid.unshift(Array(COLS).fill(0)))})),e>0&&(account.score+=this.getLinesClearedPoints(e),account.lines+=e,account.lines>=LINES_PER_LEVEL&&(account.level++,account.lines-=LINES_PER_LEVEL,time.level=LEVEL[account.level]))}valid(e){return e.shape.every(((t,i)=>t.every(((t,r)=>{let n=e.x+r,a=e.y+i;return 0===t||this.isInsideWalls(n,a)&&this.notOccupied(n,a)}))))}freeze(){this.piece.shape.forEach(((e,t)=>{e.forEach(((e,i)=>{e>0&&(this.grid[t+this.piece.y][i+this.piece.x]=e)}))}))}drawBoard(){this.grid.forEach(((e,t)=>{e.forEach(((e,i)=>{ent.findByPath(["R"+t,i.toString()]).element.color=e>0?new pc.Color(255,0,0):new pc.Color(255,255,255)}))}))}isInsideWalls(e,t){return e>=0&&e<COLS&&t<=ROWS}notOccupied(e,t){return this.grid[t]&&0===this.grid[t][e]}rotate(e,t){let i=JSON.parse(JSON.stringify(e));if(!e.hardDropped){for(let e=0;e<i.shape.length;++e)for(let t=0;t<e;++t)[i.shape[t][e],i.shape[e][t]]=[i.shape[e][t],i.shape[t][e]];t===ROTATION.RIGHT?i.shape.forEach((e=>e.reverse())):t===ROTATION.LEFT&&i.shape.reverse()}return i}getEmptyGrid(){return Array.from({length:ROWS},(()=>Array(COLS).fill(0)))}getLinesClearedPoints(e,t){const i=1===e?POINTS.SINGLE:2===e?POINTS.DOUBLE:3===e?POINTS.TRIPLE:4===e?POINTS.TETRIS:0;return(account.level+1)*i}}let board=new TBoard;var isRunning=!1;function play(){resetGame(),isRunning=!0,console.table(board.grid)}function resetGame(){account.score=0,account.lines=0,account.level=0,board.reset(),time={start:performance.now(),elapsed:0,level:LEVEL[account.level]}}function handleKeyPress(e){if(console.log(e.key),e.key===pc.KEY_P&&pause(),e.key===pc.KEY_ESCAPE)gameOver();else if(moves[e.key]){e.event.preventDefault();let t=moves[e.key](board.piece);if(e.key===pc.KEY_SPACE){for(;board.valid(t);)account.score+=POINTS.HARD_DROP,board.piece.move(t),t=moves[pc.KEY_DOWN](board.piece);board.piece.hardDrop()}else board.valid(t)&&(board.piece.move(t),e.keyCode===pc.KEY_DOWN&&(account.score+=POINTS.SOFT_DROP))}}function animate(e=0){time.elapsed=e-time.start,time.elapsed>time.level&&(time.start=e,!board.drop())?gameOver():board.draw()}function pause(){}function gameOver(){isRunning=!1,refToSelf.fire("gameOver",account)}Main.prototype.initialize=function(){gui=this.entity.parent,refToSelf=this,this.menuEntity.script.menu.on("startGame",play),this.app.keyboard.on(pc.EVENT_KEYDOWN,this.onKeyDown,this),gui.findByPath("ExitButton").button.on("click",gameOver,this)},Main.prototype.update=function(e){isRunning&&animate(performance.now())},Main.prototype.onKeyDown=function(e){handleKeyPress(e)};var menuUI,gameUI,startButton,exitButton,Menu=pc.createScript("menu");function showMenu(t){menuUI.enabled=!0,gameUI.enabled=!1,null!==localStorage.getItem("LocalScore")&&t.score>localStorage.getItem("LocalScore")&&(localStorage.setItem("LocalScore",t.score),menuUI.findByPath("ScoreLabel").element.text="Mejor puntaje: "+localStorage.getItem("LocalScore")),console.log(t.score)}Menu.attributes.add("gameUIEntity",{type:"entity"}),Menu.prototype.initialize=function(){menuUI=this.entity.findByPath("Menu"),gameUI=this.entity.findByPath("UI"),startButton=this.entity.findByPath("Menu/StartButton"),exitButton=this.entity.findByPath("UI/ExitButton"),startButton.button.on("click",(function(t){menuUI.enabled=!1,gameUI.enabled=!0,this.fire("startGame")}),this),this.gameUIEntity.script.main.on("gameOver",showMenu),null!=localStorage.getItem("LocalScore")?menuUI.findByPath("ScoreLabel").element.text="Mejor puntaje: "+localStorage.getItem("LocalScore"):menuUI.findByPath("ScoreLabel").element.text="Mejor puntaje: 0"},Menu.prototype.update=function(t){};