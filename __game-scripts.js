var Constants=pc.createScript("constants");const COLS=10,ROWS=20,LINES_PER_LEVEL=10;"use strict";var Piece=pc.createScript("piece");Piece.attributes.add("textures",{type:"asset",assetType:"texture",array:!0,title:"Textures"});var pieceSelf,entP=null,nextEnt=null;const SHAPES=[[],[[0,0,0,0],[2,2,2,2],[0,0,0,0],[0,0,0,0]],[[1,0,0],[1,1,1],[0,0,0]],[[0,0,3],[3,3,3],[0,0,0]],[[2,2],[2,2]],[[0,1,1],[1,1,0],[0,0,0]],[[0,3,0],[3,3,3],[0,0,0]],[[2,2,0],[0,2,2],[0,0,0]]],KEY={ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,P:80,Q:81},ROTATION={LEFT:"left",RIGHT:"right"},POINTS={SINGLE:100,DOUBLE:300,TRIPLE:500,TETRIS:800,SOFT_DROP:1,HARD_DROP:2},LEVEL={0:800,1:720,2:630,3:550,4:470,5:380,6:300,7:220,8:130,9:100,10:80,11:80,12:80,13:70,14:70,15:70,16:50,17:50,18:50,19:30,20:30};class TPiece{constructor(e){this.isNext=e,this.spawn()}spawn(){this.typeId=this.randomizeTetrominoType(SHAPES.length-1),this.shape=SHAPES[this.typeId],this.color=new pc.Color(255,0,0),this.x=0,this.y=0,this.hardDropped=!1}draw(){this.isNext&&this.clearNext(),this.shape.forEach(((e,t)=>{e.forEach(((e,i)=>{this.isNext?e>0&&(nextEnt.findByPath(["R"+t,i.toString()]).element.texture=pieceSelf.textures[e].resource):e>0&&(entP.findByPath(["R"+(this.y+t),(this.x+i).toString()]).element.texture=pieceSelf.textures[e].resource)}))}))}clearNext(){nextEnt.forEach((function(e){e.element&&(e.element.texture=pieceSelf.textures[0].resource)}))}move(e){this.hardDropped||(this.x=e.x,this.y=e.y),this.shape=e.shape}hardDrop(){this.hardDropped=!0}setStartingPosition(){this.x=4===this.typeId?4:3}randomizeTetrominoType(e){return Math.floor(Math.random()*e+1)}}[SHAPES,KEY,ROTATION,LEVEL,POINTS].forEach((e=>Object.freeze(e))),Piece.prototype.initialize=function(){entP=this.entity,nextEnt=this.entity.parent.findByName("NextBoard"),pieceSelf=this},Piece.prototype.update=function(e){};var Board=pc.createScript("board"),nextEnt=null;Board.prototype.initialize=function(){nextEnt=this.entity.parent.findByName("NextBoard"),console.log(nextEnt.element.color),console.log(this.entity.findByPath("R1/2").name)},Board.prototype.update=function(t){};var Main=pc.createScript("main");Main.attributes.add("menuEntity",{type:"entity"});var refToSelf,ent,startTimeStamp,gui=this.entity;let accountValues={score:0,level:0,lines:0};function updateAccount(e,t){let i=gui.findByName(e+"Label");console.log(e+"Label"),i&&(i.element.text=e+": "+t)}let account=new Proxy(accountValues,{set:(e,t,i)=>(e[t]=i,updateAccount(t,i),!0)}),time=null;const moves={[pc.KEY_LEFT]:e=>({...e,x:e.x-1}),[pc.KEY_RIGHT]:e=>({...e,x:e.x+1}),[pc.KEY_DOWN]:e=>({...e,y:e.y+1}),[pc.KEY_SPACE]:e=>({...e,y:e.y+1}),[pc.KEY_UP]:e=>board.rotate(e,ROTATION.RIGHT),[pc.KEY_Q]:e=>board.rotate(e,ROTATION.LEFT)};class TBoard{reset(){this.grid=this.getEmptyGrid(),this.piece=new TPiece(!1),this.piece.setStartingPosition(),this.getNewPiece()}getNewPiece(){this.next=new TPiece(!0),this.next.draw()}draw(){this.drawBoard(),this.piece.draw()}drop(){let e=moves[KEY.DOWN](this.piece);if(this.valid(e))this.piece.move(e);else{if(this.freeze(),this.clearLines(),0===this.piece.y)return!1;this.piece=this.next,this.piece.isNext=!1,this.piece.setStartingPosition(),this.getNewPiece()}return!0}clearLines(){let e=0;this.grid.forEach(((t,i)=>{t.every((e=>e>0))&&(e++,this.grid.splice(i,1),this.grid.unshift(Array(COLS).fill(0)))})),e>0&&(account.score+=this.getLinesClearedPoints(e),account.lines+=e,account.lines>=LINES_PER_LEVEL&&(account.level++,account.lines-=LINES_PER_LEVEL,time.level=LEVEL[account.level]))}valid(e){return e.shape.every(((t,i)=>t.every(((t,r)=>{let a=e.x+r,n=e.y+i;return 0===t||this.isInsideWalls(a,n)&&this.notOccupied(a,n)}))))}freeze(){this.piece.shape.forEach(((e,t)=>{e.forEach(((e,i)=>{e>0&&(this.grid[t+this.piece.y][i+this.piece.x]=e)}))}))}drawBoard(){this.grid.forEach(((e,t)=>{e.forEach(((e,i)=>{ent.findByPath(["R"+t,i.toString()]).element.texture=e>0?pieceSelf.textures[e].resource:pieceSelf.textures[0].resource}))}))}isInsideWalls(e,t){return e>=0&&e<COLS&&t<=ROWS}notOccupied(e,t){return this.grid[t]&&0===this.grid[t][e]}rotate(e,t){let i=JSON.parse(JSON.stringify(e));if(!e.hardDropped){for(let e=0;e<i.shape.length;++e)for(let t=0;t<e;++t)[i.shape[t][e],i.shape[e][t]]=[i.shape[e][t],i.shape[t][e]];t===ROTATION.RIGHT?i.shape.forEach((e=>e.reverse())):t===ROTATION.LEFT&&i.shape.reverse()}return i}getEmptyGrid(){return Array.from({length:ROWS},(()=>Array(COLS).fill(0)))}getLinesClearedPoints(e,t){const i=1===e?POINTS.SINGLE:2===e?POINTS.DOUBLE:3===e?POINTS.TRIPLE:4===e?POINTS.TETRIS:0;return(account.level+1)*i}}let board=new TBoard;var isRunning=!1;function play(){resetGame(),isRunning=!0,startTimeStamp=Date.now(),console.table(board.grid)}function resetGame(){account.score=0,account.lines=0,account.level=0,board.reset(),time={start:performance.now(),elapsed:0,level:LEVEL[account.level]}}function handleKeyPress(e){if(console.log(e.key),e.key===pc.KEY_P&&pause(),e.key===pc.KEY_ESCAPE)gameOver();else if(moves[e.key]){e.event.preventDefault();let t=moves[e.key](board.piece);if(e.key===pc.KEY_SPACE){for(;board.valid(t);)account.score+=POINTS.HARD_DROP,board.piece.move(t),t=moves[pc.KEY_DOWN](board.piece);board.piece.hardDrop()}else board.valid(t)&&(board.piece.move(t),e.key===pc.KEY_DOWN&&(account.score+=POINTS.SOFT_DROP))}}Main.prototype.initialize=function(){gui=this.entity.parent,refToSelf=this,this.menuEntity.script.menu.on("startGame",play),this.app.keyboard.on(pc.EVENT_KEYDOWN,this.onKeyDown,this),gui.findByPath("ExitButton").button.on("click",gameOver,this),ent=this.entity},Main.prototype.update=function(e){isRunning&&animate(performance.now())},Main.prototype.onKeyDown=function(e){handleKeyPress(e)};var skipFrame=!0;function animate(e=0){time.elapsed=e-time.start,time.elapsed>time.level&&(time.start=e,!board.drop())?gameOver():board.draw()}function pause(){}function gameOver(){isRunning=!1;var e=Math.abs(Date.now()-startTimeStamp);refToSelf.fire("gameOver",account,e)}var menuUI,gameUI,wallUI,startButton,exitButton,wallButton,Menu=pc.createScript("menu");function padTo2Digits(e){return e.toString().padStart(2,"0")}function convertMsToTime(e){let t=Math.floor(e/1e3),n=Math.floor(t/60),o=Math.floor(n/60);return t%=60,n%=60,`${padTo2Digits(o)}:${padTo2Digits(n)}:${padTo2Digits(t)}`}function showMenu(e,t){menuUI.enabled=!0,gameUI.enabled=!1,(null==sessionStorage.getItem("LocalScore")||e.score>sessionStorage.getItem("LocalScore"))&&(sessionStorage.setItem("LocalScore",e.score),sessionStorage.setItem("LocalTime",t)),menuUI.findByPath("BestScoreLabel").element.text="Mejor puntaje: "+sessionStorage.getItem("LocalScore"),menuUI.findByPath("BestTimeLabel").element.text="Tiempo de juego: "+convertMsToTime(sessionStorage.getItem("LocalTime")),menuUI.findByPath("ScoreLabel").element.text="Ultimo puntaje: "+e.score,menuUI.findByPath("TimeLabel").element.text="Tiempo de juego: "+convertMsToTime(t),console.log(e.score)}Menu.attributes.add("gameUIEntity",{type:"entity"}),Menu.attributes.add("wallUIEntity",{type:"entity"}),Menu.prototype.initialize=function(){menuUI=this.entity.findByPath("Menu"),gameUI=this.entity.findByPath("UI"),wallUI=this.entity.findByPath("Wall"),startButton=this.entity.findByPath("Menu/StartButton"),exitButton=this.entity.findByPath("UI/ExitButton"),wallButton=this.entity.findByPath("Menu/WallButton"),startButton.button.on("click",(function(e){menuUI.enabled=!1,gameUI.enabled=!0,this.fire("startGame")}),this),wallButton.button.on("click",(function(e){menuUI.enabled=!1,wallUI.enabled=!0,this.fire("openWall")}),this),this.gameUIEntity.script.main.on("gameOver",showMenu),this.wallUIEntity.script.wall.on("showMenu",(function(e){menuUI.enabled=!0,wallUI.enabled=!1}),this),null!=sessionStorage.getItem("LocalScore")?menuUI.findByPath("BestScoreLabel").element.text="Mejor puntaje: "+sessionStorage.getItem("LocalScore"):menuUI.findByPath("BestScoreLabel").element.text="Mejor puntaje: 0",null!=sessionStorage.getItem("LocalTime")?menuUI.findByPath("BestTimeLabel").element.text="Tiempo de juego: "+convertMsToTime(sessionStorage.getItem("LocalTime")):menuUI.findByPath("BestTimeLabel").element.text="Tiempo de juego: 00:00:00"},Menu.prototype.update=function(e){};var Wall=pc.createScript("wall"),bricks=0;const brickWidth=72,brickHeight=36,maxWidth=720,minHeight=720;var content,brickTemplate,resetAnim=!1,playAnim=!1;const bricksPerLine=Math.floor(10);var brickIndex=0;function playWallAnimation(){resetAnim=!0}Wall.attributes.add("menuEntity",{type:"entity"}),Wall.prototype.initialize=function(){bricks=126,this.menuEntity.script.menu.on("openWall",playWallAnimation),content=this.entity.findByPath("ScrollView/Viewport/Content/BG"),brickTemplate=this.entity.findByPath("Brick"),this.entity.findByPath("ExitButton").button.on("click",(function(i){this.fire("showMenu")}),this)},Wall.prototype.update=function(i){if(resetAnim&&(playAnim=!0,content.children.forEach((i=>content.removeChild(i))),brickIndex=0,resetAnim=!1),playAnim)if(brickIndex<bricks)if(72*(bricks-brickIndex)>720)for(var e=0;e<bricksPerLine;e++){var t=36*Math.floor(brickIndex/bricksPerLine),n=72*e,r=brickTemplate.clone();content.addChild(r),r.setLocalPosition(n,t,0),r.enabled=!0,brickIndex++}else{t=36*Math.floor(brickIndex/bricksPerLine),n=brickIndex%bricksPerLine*72,r=brickTemplate.clone();content.addChild(r),r.setLocalPosition(n,t,0),r.enabled=!0,brickIndex++}else playAnim=!1,36*(Math.floor(brickIndex/bricksPerLine)+1)>720?this.entity.findByPath("ScrollView/Viewport/Content").element.height=36*(Math.floor(brickIndex/bricksPerLine)+1):this.entity.findByPath("ScrollView/Viewport/Content").element.height=720};