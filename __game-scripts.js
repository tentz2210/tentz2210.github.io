var Constants=pc.createScript("constants");const COLS=10,ROWS=20,LINES_PER_LEVEL=10;"use strict";var Piece=pc.createScript("piece");Piece.attributes.add("textures",{type:"asset",assetType:"texture",array:!0,title:"Textures"});var pieceSelf,entP=null,nextEnt=null;const SHAPES=[[],[[0,0,0,0],[2,2,2,2],[0,0,0,0],[0,0,0,0]],[[1,0,0],[1,1,1],[0,0,0]],[[0,0,3],[3,3,3],[0,0,0]],[[2,2],[2,2]],[[0,1,1],[1,1,0],[0,0,0]],[[0,3,0],[3,3,3],[0,0,0]],[[2,2,0],[0,2,2],[0,0,0]]],KEY={ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,P:80,Q:81},ROTATION={LEFT:"left",RIGHT:"right"},POINTS={SINGLE:100,DOUBLE:300,TRIPLE:500,TETRIS:800,SOFT_DROP:1,HARD_DROP:2},LEVEL={0:800,1:720,2:630,3:550,4:470,5:380,6:300,7:220,8:130,9:100,10:80,11:80,12:80,13:70,14:70,15:70,16:50,17:50,18:50,19:30,20:30};class TPiece{constructor(e){this.isNext=e,this.spawn()}spawn(){this.typeId=this.randomizeTetrominoType(SHAPES.length-1),this.shape=SHAPES[this.typeId],this.color=new pc.Color(255,0,0),this.x=0,this.y=0,this.hardDropped=!1}draw(){this.isNext&&this.clearNext(),this.shape.forEach(((e,t)=>{e.forEach(((e,i)=>{this.isNext?e>0&&(nextEnt.findByPath(["R"+t,i.toString()]).element.texture=pieceSelf.textures[e].resource):e>0&&(entP.findByPath(["R"+(this.y+t),(this.x+i).toString()]).element.texture=pieceSelf.textures[e].resource,entP.findByPath(["R"+(this.y+t),(this.x+i).toString()]).element.opacity=1)}))}))}clearNext(){nextEnt.forEach((function(e){e.element&&(e.element.texture=pieceSelf.textures[0].resource)}))}move(e){this.hardDropped||(this.x=e.x,this.y=e.y),this.shape=e.shape}hardDrop(){this.hardDropped=!0}setStartingPosition(){this.x=4===this.typeId?4:3}randomizeTetrominoType(e){return Math.floor(Math.random()*e+1)}}[SHAPES,KEY,ROTATION,LEVEL,POINTS].forEach((e=>Object.freeze(e))),Piece.prototype.initialize=function(){entP=this.entity,nextEnt=this.entity.parent.findByName("NextBoard"),pieceSelf=this},Piece.prototype.update=function(e){};var Board=pc.createScript("board"),nextEnt=null;Board.prototype.initialize=function(){nextEnt=this.entity.parent.findByName("NextBoard"),console.log(nextEnt.element.color),console.log(this.entity.findByPath("R1/2").name)},Board.prototype.update=function(t){};var Main=pc.createScript("main");Main.attributes.add("menuEntity",{type:"entity"}),Main.attributes.add("fadeOutElement",{type:"entity"});var refToSelf,ent,startTimeStamp,gui=this.entity;let accountValues={score:0,level:0,lines:0};function updateAccount(e,t){let i=gui.findByName(e+"Label");console.log(e+"Label"),i&&(i.element.text=t)}let account=new Proxy(accountValues,{set:(e,t,i)=>(e[t]=i,updateAccount(t,i),!0)}),time=null;const moves={[pc.KEY_LEFT]:e=>({...e,x:e.x-1}),[pc.KEY_RIGHT]:e=>({...e,x:e.x+1}),[pc.KEY_DOWN]:e=>({...e,y:e.y+1}),[pc.KEY_SPACE]:e=>({...e,y:e.y+1}),[pc.KEY_UP]:e=>board.rotate(e,ROTATION.RIGHT),[pc.KEY_Q]:e=>board.rotate(e,ROTATION.LEFT)};class TBoard{reset(){this.grid=this.getEmptyGrid(),this.piece=new TPiece(!1),this.piece.setStartingPosition(),this.getNewPiece()}getNewPiece(){this.next=new TPiece(!0),this.next.draw()}draw(){this.drawBoard(),this.piece.draw()}drop(){let e=moves[KEY.DOWN](this.piece);if(this.valid(e))this.piece.move(e);else{if(this.freeze(),this.clearLines(),0===this.piece.y)return!1;this.piece=this.next,this.piece.isNext=!1,this.piece.setStartingPosition(),this.getNewPiece()}return!0}clearLines(){let e=0;this.grid.forEach(((t,i)=>{t.every((e=>e>0))&&(e++,this.grid.splice(i,1),this.grid.unshift(Array(COLS).fill(0)))})),e>0&&(account.score+=this.getLinesClearedPoints(e),account.lines+=e,account.lines>=LINES_PER_LEVEL&&(account.level++,account.lines-=LINES_PER_LEVEL,time.level=LEVEL[account.level]))}valid(e){return e.shape.every(((t,i)=>t.every(((t,a)=>{let s=e.x+a,n=e.y+i;return 0===t||this.isInsideWalls(s,n)&&this.notOccupied(s,n)}))))}freeze(){this.piece.shape.forEach(((e,t)=>{e.forEach(((e,i)=>{e>0&&(this.grid[t+this.piece.y][i+this.piece.x]=e)}))}))}drawBoard(){this.grid.forEach(((e,t)=>{e.forEach(((e,i)=>{e>0?(ent.findByPath(["R"+t,i.toString()]).element.texture=pieceSelf.textures[e].resource,ent.findByPath(["R"+t,i.toString()]).element.opacity=1):(ent.findByPath(["R"+t,i.toString()]).element.texture=pieceSelf.textures[0].resource,ent.findByPath(["R"+t,i.toString()]).element.opacity=.2)}))}))}isInsideWalls(e,t){return e>=0&&e<COLS&&t<=ROWS}notOccupied(e,t){return this.grid[t]&&0===this.grid[t][e]}rotate(e,t){let i=JSON.parse(JSON.stringify(e));if(!e.hardDropped){for(let e=0;e<i.shape.length;++e)for(let t=0;t<e;++t)[i.shape[t][e],i.shape[e][t]]=[i.shape[e][t],i.shape[t][e]];t===ROTATION.RIGHT?i.shape.forEach((e=>e.reverse())):t===ROTATION.LEFT&&i.shape.reverse()}return i}getEmptyGrid(){return Array.from({length:ROWS},(()=>Array(COLS).fill(0)))}getLinesClearedPoints(e,t){const i=1===e?POINTS.SINGLE:2===e?POINTS.DOUBLE:3===e?POINTS.TRIPLE:4===e?POINTS.TETRIS:0;return(account.level+1)*i}}let board=new TBoard;var sidestepSize,hardDropSize,isRunning=!1;function play(){resetGame(),setTimeout((()=>{isRunning=!0,startTimeStamp=Date.now()}),2e3),console.table(board.grid)}function resetGame(){account.score=0,account.lines=0,account.level=0,board.reset(),time={start:performance.now(),elapsed:0,level:LEVEL[account.level]}}Main.prototype.initialize=function(){gui=this.entity.parent,refToSelf=this,this.menuEntity.script.menu.on("startGame",play),this.app.keyboard.on(pc.EVENT_KEYDOWN,this.onKeyDown,this),gui.findByPath("ExitButton").button.on("click",gameOver,this),ent=this.entity;var e=this.app.touch;e&&(e.on(pc.EVENT_TOUCHEND,(function(e){e.event.preventDefault()})),this.entity.element.on("touchstart",this.onTouchStart,this),this.entity.element.on("touchmove",this.onTouchMove,this),this.entity.element.on("touchend",this.onTouchEnd,this)),this.on("destroy",(function(){}),this)},Main.prototype.update=function(e){isRunning&&animate(1e3*e);var t=this.entity.element.canvasCorners,i=t[1].x-t[0].x,a=t[1].y-t[2].y;sidestepSize=i/9,hardDropSize=a/5;this.entity.element.calculatedWidth,this.entity.element.calculatedHeight;gui.findByName("boardSizeLabel").element.text="Width: "+i+"\nHeight: "+a},Main.prototype.onKeyDown=function(e){handleKeyPress(e)};var pressTimestamp,startX=0,startY=0,xDisplacement=0,yDisplacement=0,sidestepped=!1,hardDropped=!1;function handleKeyPress(e){if(console.log(e.key),e.key===pc.KEY_P&&pause(),e.key===pc.KEY_ESCAPE)gameOver();else if(moves[e.key]){e.event.preventDefault();let t=moves[e.key](board.piece);if(e.key===pc.KEY_SPACE){for(;board.valid(t);)account.score+=POINTS.HARD_DROP,board.piece.move(t),t=moves[pc.KEY_DOWN](board.piece);board.piece.hardDrop()}else board.valid(t)&&(board.piece.move(t),e.key===pc.KEY_DOWN&&(account.score+=POINTS.SOFT_DROP))}}Main.prototype.onTouchStart=function(e){e.stopPropagation(),1===e.touches.length&&(pressTimestamp=pc.now(),sidestepped=!1,hardDropped=!1,startX=e.touches[0].screenX,startY=e.touches[0].screenY,xDisplacement=0,yDisplacement=0,gui.findByName("touchLabel").element.text="X: "+e.touches[0].screenX+" Y: "+e.touches[0].screenY)},Main.prototype.onTouchMove=function(e){e.stopPropagation(),xDisplacement=e.touches[0].screenX-startX,yDisplacement=e.touches[0].screenY-startY,gui.findByName("touchLabel").element.text="X: "+e.touches[0].screenX+" Y: "+e.touches[0].screenY,gui.findByName("displacementLabel").element.text="X: "+xDisplacement+" Y: "+yDisplacement;var t=Math.abs(pc.now()-pressTimestamp);let i;if(Math.abs(xDisplacement)>sidestepSize)sidestepped=!0,i=xDisplacement<0?moves[pc.KEY_LEFT](board.piece):moves[pc.KEY_RIGHT](board.piece),startX=e.touches[0].screenX,startY=e.touches[0].screenY,xDisplacement=0,yDisplacement=0,board.valid(i)&&board.piece.move(i);else if(yDisplacement>hardDropSize&&t<1e3&&!hardDropped){for(startX=e.touches[0].screenX,startY=e.touches[0].screenY,xDisplacement=0,yDisplacement=0,i=moves[pc.KEY_DOWN](board.piece);board.valid(i);)account.score+=POINTS.HARD_DROP,board.piece.move(i),i=moves[pc.KEY_DOWN](board.piece);board.piece.hardDrop()}},Main.prototype.onTouchEnd=function(e){e.stopPropagation();var t=Math.abs(pc.now()-pressTimestamp);if(t<250&&!sidestepped){console.log("Touch ended Press time: "+t);let e=moves[pc.KEY_UP](board.piece);board.valid(e)&&board.piece.move(e)}};var hardDropDB=!1;function animate(e){time.elapsed+=e,board.piece.hardDropped&&!hardDropDB&&(time.elapsed=0,hardDropDB=!0),time.elapsed>time.level&&(time.elapsed=0,hardDropDB=!1,!board.drop())?gameOver():board.draw()}function pause(){}function gameOver(){isRunning=!1;var e=Math.abs(Date.now()-startTimeStamp);refToSelf.fire("gameOver",account,e),board.reset(),board.drawBoard()}var menuUI,gameUI,wallUI,startButton,exitButton,wallButton,isFadeout,Menu=pc.createScript("menu");function padTo2Digits(t){return t.toString().padStart(2,"0")}function convertMsToTime(t){let e=Math.floor(t/1e3),n=Math.floor(e/60),o=Math.floor(n/60);return e%=60,n%=60,`${padTo2Digits(o)}:${padTo2Digits(n)}:${padTo2Digits(e)}`}Menu.attributes.add("gameUIEntity",{type:"entity"}),Menu.attributes.add("wallUIEntity",{type:"entity"}),Menu.attributes.add("fadeOutElement",{type:"entity"}),Menu.prototype.initialize=function(){menuUI=this.entity.findByPath("Menu"),gameUI=this.entity.findByPath("UI"),wallUI=this.entity.findByPath("Wall"),startButton=this.entity.findByPath("Menu/StartButton"),exitButton=this.entity.findByPath("UI/ExitButton"),instructionsButton=this.entity.findByPath("Menu/InstructionsButton"),wallButton=this.entity.findByPath("Menu/WallButton"),isFadeout=!0,startButton.button.on("click",(function(t){isFadeout=!0,startButton.button.active=!1,wallButton.button.active=!1,setTimeout((()=>{menuUI.enabled=!1,gameUI.enabled=!0,isFadeout=!1,this.fire("startGame")}),2e3)}),this),wallButton.button.on("click",(function(t){isFadeout=!0,startButton.button.active=!1,wallButton.button.active=!1,setTimeout((()=>{menuUI.enabled=!1,wallUI.enabled=!0,isFadeout=!1}),2e3)}),this),instructionsButton.button.on("click",(function(t){this.entity.findByPath("Menu/InstructionsPopup").enabled=!0}),this),this.gameUIEntity.script.main.on("gameOver",showMenu),this.wallUIEntity.script.wall.on("showMenu",(function(t){menuUI.enabled=!0,wallUI.enabled=!1,startButton.button.active=!0,wallButton.button.active=!0}),this),null!=sessionStorage.getItem("LocalScore")?menuUI.findByPath("BestScoreLabel").element.text="Mejor puntaje: "+sessionStorage.getItem("LocalScore"):menuUI.findByPath("BestScoreLabel").element.text="Mejor puntaje: 0",null!=sessionStorage.getItem("LocalTime")?menuUI.findByPath("BestTimeLabel").element.text="Tiempo de juego: "+convertMsToTime(sessionStorage.getItem("LocalTime")):menuUI.findByPath("BestTimeLabel").element.text="Tiempo de juego: 00:00:00"};const clamp=(t,e,n)=>Math.min(Math.max(t,e),n);function showMenu(t,e){startButton.button.active=!0,wallButton.button.active=!0,(null==sessionStorage.getItem("LocalScore")||t.score>sessionStorage.getItem("LocalScore"))&&(sessionStorage.setItem("LocalScore",t.score),sessionStorage.setItem("LocalTime",e)),menuUI.findByPath("BestScoreLabel").element.text="Mejor puntaje: "+sessionStorage.getItem("LocalScore"),menuUI.findByPath("BestTimeLabel").element.text="Tiempo de juego: "+convertMsToTime(sessionStorage.getItem("LocalTime")),menuUI.findByPath("ScoreLabel").element.text="Ultimo puntaje: "+t.score,menuUI.findByPath("TimeLabel").element.text="Tiempo de juego: "+convertMsToTime(e),isFadeout=!0,exitButton.button.active=!1,setTimeout((()=>{menuUI.enabled=!0,gameUI.enabled=!1,exitButton.button.active=!0,isFadeout=!1}),2e3),console.log(t.score)}Menu.prototype.update=function(t){this.fadeOutElement.element.opacity=clamp(isFadeout?this.fadeOutElement.element.opacity+1*t:this.fadeOutElement.element.opacity-1*t,0,1)};var Wall=pc.createScript("wall");function playWallAnimation(){}Wall.attributes.add("pieces",{type:"entity",array:!0,title:"Wall Pieces"}),Wall.attributes.add("menuEntity",{type:"entity"}),Wall.prototype.initialize=function(){this.currentLevel=-1,this.wallMaxLevel=this.pieces.length,this.menuEntity.script.menu.on("openWall",playWallAnimation),this.entity.findByPath("ExitButton").button.on("click",(function(t){isFadeout=!0,setTimeout((()=>{this.entity.enabled=!1,isFadeout=!1,this.fire("showMenu")}),2e3)}),this),this.entity.findByPath("PlusButton").button.on("click",(function(t){this.currentLevel=clamp(this.currentLevel+1,-1,this.wallMaxLevel-1),this.setWallLevel()}),this),this.entity.findByPath("MinusButton").button.on("click",(function(t){this.currentLevel=clamp(this.currentLevel-1,-1,this.wallMaxLevel-1),console.log(this.currentLevel),this.setWallLevel()}),this)},Wall.prototype.update=function(t){},Wall.prototype.setWallLevel=function(){for(var t=0;t<this.wallMaxLevel;t++)t<=this.currentLevel?(this.pieces[t].enabled=!0,console.log("piece "+t+" enabled")):this.pieces[t].enabled=!1};var AnimateSprite=pc.createScript("animateSprite");AnimateSprite.attributes.add("startFrame",{type:"number",default:0,description:"Frame to start animation from"}),AnimateSprite.attributes.add("numFrames",{type:"number",default:1,description:"Number of frames to play before looping"}),AnimateSprite.attributes.add("frameRate",{type:"number",default:1,description:"Playback frames per second"}),AnimateSprite.prototype.initialize=function(){this.timer=1/this.frameRate,this.frame=this.startFrame},AnimateSprite.prototype.update=function(t){this.timer-=t,this.timer<0&&(this.frame++,this.frame>=this.numFrames+this.startFrame&&(this.frame=this.startFrame),this.entity.element.spriteFrame=this.frame,this.timer=1/this.frameRate)};var MoveSprite=pc.createScript("moveSprite");MoveSprite.prototype.initialize=function(){this.startX=this.entity.getPosition().x,this.startY=this.entity.getPosition().y,this.currentVal=0,this.setPosition(0),this.loopInterval=5},MoveSprite.prototype.update=function(t){this.loopInterval-=t,this.loopInterval<0&&(this.currentVal+=t/4,this.setPosition(this.currentVal),this.currentVal>=1&&(this.currentVal=0,this.loopInterval=5))},MoveSprite.prototype.setPosition=function(t){t=pc.math.clamp(t,0,1);var i=pc.math.lerp(this.startX,-1*this.startX,t);this.entity.setPosition(i,this.startY,0)};var IntroSequence=pc.createScript("introSequence");IntroSequence.attributes.add("fadeOutElement",{type:"entity"}),IntroSequence.prototype.initialize=function(){isFadeout=!1;var e=0;this.fadeOutElement.element.opacity=1,e+=3500,setTimeout((()=>{isFadeout=!0}),e),e+=2e3,setTimeout((()=>{isFadeout=!1,this.entity.findByPath("LogoLiga").enabled=!1,this.entity.findByPath("LogoUmbro").enabled=!0}),e),e+=2e3,setTimeout((()=>{isFadeout=!0}),e),e+=2e3,setTimeout((()=>{isFadeout=!1,this.entity.findByPath("LogoUmbro").enabled=!1,this.entity.findByPath("LogoTentmakers").enabled=!0}),e),e+=2e3,setTimeout((()=>{isFadeout=!0}),e),e+=2e3,setTimeout((()=>{isFadeout=!1,this.entity.enabled=!1}),e)},IntroSequence.prototype.update=function(e){};var WelcomePopup=pc.createScript("welcomePopup");WelcomePopup.prototype.initialize=function(){this.entity.findByPath("BG/ExitButton").button.on("click",(function(t){this.entity.enabled=!1}),this),this.entity.findByPath("InstructionsButton").button.on("click",(function(t){this.entity.enabled=!1,this.entity.parent.findByPath("InstructionsPopup").enabled=!0}),this)},WelcomePopup.prototype.update=function(t){};var PagedPopup=pc.createScript("pagedPopup");PagedPopup.attributes.add("pages",{type:"entity",array:!0,title:"Pages"}),PagedPopup.prototype.initialize=function(){this.currentPage=0,this.totalPages=this.pages.length,this.entity.findByPath("BG/NextButton").button.on("click",(function(t){this.pages[this.currentPage].enabled=!1,this.currentPage++,this.currentPage+1>=this.totalPages&&(this.entity.findByPath("BG/NextButton").enabled=!1),this.pages[this.currentPage].enabled=!0}),this),this.entity.findByPath("BG/ExitButton").button.on("click",(function(t){this.entity.enabled=!1,this.pages[0].enabled=!0,this.currentPage=0,this.entity.findByPath("BG/NextButton").enabled=!0;for(var e=1;e<this.totalPages;e++)this.pages[e].enabled=!1}),this)},PagedPopup.prototype.update=function(t){};